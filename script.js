// DonnÃ©es de la checklist pour Subnautica - Version COMPLÃˆTE avec 8 chapitres chronologiques prÃ©cis
const data = {
    chapters: [
        {
            id: "chapitre-1",
            title: "Chapitre 1 : Le Crash et la Survie Initiale (Profondeur : 0-50m, Biomes : DÃ©troits SÃ»rs)",
            sections: [
                { title: "ğŸ¯ Ã€ faire / Ã‰tapes dÃ©taillÃ©es", items: [
                    "Ã‰teindre le feu dans la capsule avec l'extincteur",
                    "RÃ©parer la radio et les systÃ¨mes secondaires de la capsule (outil de rÃ©paration)",
                    "GÃ©rer faim/soif/Oâ‚‚ : pÃªcher Bladderfish/Peeper, cuisiner, purifier eau",
                    "Scanner faune/flore basique et fragments initiaux",
                    "RÃ©pondre aux premiers signaux radio (Lifepod 3 Ã  proximitÃ©)"
                ]},
                { title: "ğŸ—ºï¸ Ã€ visiter", items: [
                    "Autour de la capsule : affleurements calcaires (titane/cuivre), grottes sous la capsule (soufre)",
                    "Lifepod 3 (-30, -20, 410) pour fragments Seaglide et Boussole"
                ]},
                { title: "ğŸ”§ Ã€ crafter (Fabricateur capsule)", items: [
                    "RÃ©servoir Oâ‚‚ standard (+30s air)",
                    "Outil de rÃ©paration",
                    "Trousse de premiers soins (gÃ©nÃ©rateur mÃ©dical)",
                    "Ailerons (+15% vitesse nage)",
                    "Lampe torche",
                    "Scanner",
                    "Couteau de survie",
                    "Poches d'air, FusÃ©es Ã©clairantes"
                ]}
            ]
        },
        {
            id: "chapitre-2",
            title: "Chapitre 2 : Outils Essentiels et MobilitÃ© de Base (Profondeur : 50-150m, Biomes : ForÃªt de Varech, Plateaux Herbeux)",
            sections: [
                { title: "ğŸ¯ Ã€ faire / Ã‰tapes dÃ©taillÃ©es", items: [
                    "Explorer grottes pour soufre/acide",
                    "RÃ©pondre signaux : Lifepod 17 (-515, -95, 55) pour fragments Seamoth/BiorÃ©acteur",
                    "Scanner fragments dans dÃ©bris (ex. Gros DÃ©bris #1 : 65, -30, 385 pour Laser Coupeur)",
                    "Collecter Argent (affleurements grÃ¨s), Lithium (schiste)"
                ]},
                { title: "ğŸ—ºï¸ Ã€ visiter", items: [
                    "ForÃªt de Varech : dÃ©bris petits/gros pour Seaglide, fragments base",
                    "Plateaux Herbeux : Ã©paves pour Seamoth (TrÃ¨s Gros DÃ©bris #1 : -120, -180, 860)",
                    "Lifepod 6 (360, 110, 310) pour Ailerons Glisse Ultra"
                ]},
                { title: "ğŸ”§ Ã€ crafter", items: [
                    "Seaglide (mobilitÃ© rapide)",
                    "Boussole",
                    "Constructeur Habitat",
                    "Compartiments Habitat basiques : Ordinateur Base, Lit, Chargeur Batterie",
                    "Seamoth (aprÃ¨s fragments)"
                ]}
            ]
        },
        {
            id: "chapitre-3",
            title: "Chapitre 3 : PremiÃ¨re Base et Ãle du Sunbeam (Profondeur : 0-200m, Biomes : DÃ©troits SÃ»rs, Ãle Flottante)",
            sections: [
                { title: "ğŸ¯ Ã€ faire / Ã‰tapes dÃ©taillÃ©es", items: [
                    "Choisir spot base (ex. -830, -190, 835 prÃ¨s titane)",
                    "RÃ©pondre appel Sunbeam : arriver en <30min",
                    "Explorer Ã®le : graines arbres bulbe (nourriture/eau), schiste (lithium/or/diamant)",
                    "Entrer grottes Ã®le : sel, tablettes violettes (x3)",
                    "Alien Quarantine : insÃ©rer tablettes violettes, scanner canon alien, cubes ion, activer arche (tÃ©lÃ©porteur)"
                ]},
                { title: "ğŸ—ºï¸ Ã€ visiter", items: [
                    "Ãle Sunbeam (275, 0, 1090)",
                    "Grottes sous Ã®le : premiÃ¨re (340, 10, 1030), seconde (360, 120, 1150)",
                    "BÃ¢timent alien (390, 5, 1120)"
                ]},
                { title: "ğŸ”§ Ã€ crafter", items: [
                    "Baie VÃ©hicules Mobile",
                    "Piscine Lune",
                    "Combinaison Radiologique (zinc/fibres)",
                    "Salle Multifonction, Salle Scanner (dÃ©bloquÃ©s via fragments)"
                ]}
            ]
        },
        {
            id: "chapitre-4",
            title: "Chapitre 4 : Abordage de l'Aurora - ExtÃ©rieur et Baies (Profondeur : 100-300m, Biomes : RÃ©cifs ClairsemÃ©s)",
            sections: [
                { title: "ğŸ¯ Ã€ faire / Ã‰tapes dÃ©taillÃ©es", items: [
                    "Approcher Aurora par arriÃ¨re gauche",
                    "Ã‰teindre incendies, rÃ©parer cÃ¢blages, tuer Cave Crawlers",
                    "Explorer sÃ©diments : capsules temporaires (foreuse Prawn, barres rÃ©acteur)",
                    "Baie Cargo 3 (code 1454) : kits mÃ©dicaux",
                    "Baie Seamoth : scanner Module Profondeur MK1"
                ]},
                { title: "ğŸ—ºï¸ Ã€ visiter", items: [
                    "ExtÃ©rieur Aurora (470, -5, -310)",
                    "EntrÃ©e frontale (1150, 2, 112)",
                    "Salle Machines : rÃ©parer 11 brÃ¨ches"
                ]},
                { title: "ğŸ”§ Ã€ crafter", items: [
                    "Extincteurs (titane)",
                    "Fusil Propulsion (fragments)",
                    "Rebreather (silice/titane)"
                ]}
            ]
        },
        {
            id: "chapitre-5",
            title: "Chapitre 5 : Abordage de l'Aurora - IntÃ©rieur et Quartiers (Profondeur : 100-300m, Biomes : Zone Crash Aurora)",
            sections: [
                { title: "ğŸ¯ Ã€ faire / Ã‰tapes dÃ©taillÃ©es", items: [
                    "Administration : tÃ©lÃ©charger donnÃ©es, scanner posters",
                    "Quartiers RÃ©sidentiels : Ã©teindre feux, scanner tables bar/chaises",
                    "Cabines (codes : 1869 cab1, 2679 capitaine, 6483 Ã©chantillons) : bagages, eau",
                    "Baie Prawn : scanner combinaisons",
                    "Salle CÅ“ur : couper portes (laser), PDA/code 6483"
                ]},
                { title: "ğŸ—ºï¸ Ã€ visiter", items: [
                    "Pont SupÃ©rieur, Ponts RÃ©sidentiels",
                    "Baie Prawn"
                ]},
                { title: "ğŸ”§ Ã€ crafter", items: [
                    "Station Modification (fragments)",
                    "Cyclops (fragments moteurs Aurora/dÃ©bris)",
                    "Modules Profondeur MK1/MK2 Seamoth/Cyclops"
                ]}
            ]
        },
        {
            id: "chapitre-6",
            title: "Chapitre 6 : Grotte Champis-GelÃ©es et Base Degasi (Profondeur : 200-600m, Biomes : Grotte MÃ©duse, Grand RÃ©cif)",
            sections: [
                { title: "ğŸ¯ Ã€ faire / Ã‰tapes dÃ©taillÃ©es", items: [
                    "Miner lithium/or/magnÃ©tite (foreuse Prawn)",
                    "Explorer base Degasi : scanner Salle Multifonction/Observatoire",
                    "Collecter Å“ufs crÃ©atures, photos, lits",
                    "RÃ©pondre signaux capsules profondes (ex. Lifepod 19 : rÃ©servoir haute capacitÃ©)"
                ]},
                { title: "ğŸ—ºï¸ Ã€ visiter", items: [
                    "Grotte Champis-GelÃ©es (-370, -90, -160)",
                    "Base Degasi (-650, -503, -950)"
                ]},
                { title: "ğŸ”§ Ã€ crafter", items: [
                    "Combinaison Prawn (fragments Aurora)",
                    "Bras Prawn : Foreuse, Grappin",
                    "Centrale Thermique, Chargeur Batterie AvancÃ©"
                ]}
            ]
        },
        {
            id: "chapitre-7",
            title: "Chapitre 7 : Structures Alien Profondes (Profondeur : 700-1400m, Biomes : RiviÃ¨re Perdue, Grotte Fossiles, Labo Maladies, Centrale Thermique)",
            sections: [
                { title: "ğŸ¯ Ã€ faire / Ã‰tapes dÃ©taillÃ©es", items: [
                    "Grotte Fossiles : eau acide, tablettes orange/violettes, scanner fossiles/Å“ufs",
                    "Labo Maladies : scanner Warpers, infection Kharaa rÃ©vÃ©lÃ©e",
                    "Centrale Thermique : miner Kyanite/cubes ion, activer tÃ©lÃ©porteur Sunbeam",
                    "DÃ©sactiver champs de force (tablettes)"
                ]},
                { title: "ğŸ—ºï¸ Ã€ visiter", items: [
                    "Grotte Fossiles (-710, -710, -710)",
                    "Labo Maladies (-240, -795, 310)",
                    "Centrale Thermique (-70, -1180, 10)"
                ]},
                { title: "ğŸ”§ Ã€ crafter", items: [
                    "Modules Profondeur MK3 (Kyanite)",
                    "Fusil Stase (fragments)",
                    "Cellules Ion",
                    "Bras Coupeur Laser Prawn"
                ]}
            ]
        },
        {
            id: "chapitre-8",
            title: "Chapitre 8 : Installation Contention, GuÃ©rison et Ã‰vasion (Profondeur : 1400-1700m, Biomes : Lacs Lava, ChÃ¢teau Lava)",
            sections: [
                { title: "ğŸ¯ Ã€ faire / Ã‰tapes dÃ©taillÃ©es", items: [
                    "Miner gros nÅ“uds Kyanite",
                    "Installation : scanner expositions/Å“ufs/fÅ“tus, interagir Empereur (confiance)",
                    "Incuber Enzyme 42 (guÃ©rison), dÃ©sactiver canon alien",
                    "RÃ©cup blueprint FusÃ©e Neptune (terminal Aurora)",
                    "Construire/Activer fusÃ©e : plateforme, rampe, propulseurs, rÃ©servoir carburant, cockpit ; activer modules (Ã©nergie, comms, hydraulique)"
                ]},
                { title: "ğŸ—ºï¸ Ã€ visiter", items: [
                    "Installation Contention Primaire (220, -1451, -260)",
                    "Aquarium Empereur"
                ]},
                { title: "ğŸ”§ Ã€ crafter", items: [
                    "Enzymes Incubation",
                    "Composants FusÃ©e Neptune",
                    "Base finale : Salle Polyvalente, RÃ©acteur NuclÃ©aire si besoin"
                ]}
            ]
        }
    ]
};

document.addEventListener('DOMContentLoaded', () => {
    const chaptersList = document.getElementById('chapters-list');
    const content = document.getElementById('content');
    const resetLink = document.getElementById('reset-progress');

    let progress = JSON.parse(localStorage.getItem('subnautica-progress')) || {};

    function updateChapterProgress(chapterId) {
        const chapter = data.chapters.find(ch => ch.id === chapterId);
        if (!chapter) return { checked: 0, total: 0 };
        let total = 0;
        let checked = 0;
        chapter.sections.forEach(sec => {
            sec.items.forEach((item, index) => {
                const key = `${chapterId}-${sec.title}-${index}`;
                total++;
                if (progress[key]) checked++;
            });
        });
        return { checked, total };
    }

    function updateGlobalProgress() {
        let total = 0;
        let checked = 0;
        data.chapters.forEach(ch => {
            const p = updateChapterProgress(ch.id);
            total += p.total;
            checked += p.checked;
        });
        const percent = total > 0 ? Math.round((checked / total) * 100) : 0;
        const elem = document.getElementById('global-progress');
        if (elem) {
            elem.textContent = `Progression globale : ${percent}% (${checked}/${total} tÃ¢ches)`;
        }
    }

    // Remplir la sidebar
    data.chapters.forEach(chapter => {
        const li = document.createElement('li');
        const prog = updateChapterProgress(chapter.id);
        const a = document.createElement('a');
        a.href = `#${chapter.id}`;
        a.textContent = `${chapter.title} (${prog.checked}/${prog.total})`;
        a.addEventListener('click', (e) => {
            e.preventDefault();
            renderChapter(chapter);
            window.location.hash = chapter.id;
        });
        li.appendChild(a);
        chaptersList.appendChild(li);
    });

    function renderChapter(chapter) {
        content.innerHTML = '';

        const checkAllBtn = document.createElement('button');
        checkAllBtn.textContent = "Tout cocher ce chapitre";
        checkAllBtn.style.margin = '0 0 20px 0';
        checkAllBtn.style.padding = '10px 20px';
        checkAllBtn.style.background = '#004d40';
        checkAllBtn.style.color = '#b2ebf2';
        checkAllBtn.style.border = '1px solid #00acc1';
        checkAllBtn.style.borderRadius = '8px';
        checkAllBtn.style.cursor = 'pointer';
        checkAllBtn.onclick = () => {
            chapter.sections.forEach(sec => {
                sec.items.forEach((_, index) => {
                    const key = `${chapter.id}-${sec.title}-${index}`;
                    progress[key] = true;
                });
            });
            localStorage.setItem('subnautica-progress', JSON.stringify(progress));
            renderChapter(chapter);
            updateGlobalProgress();
            const link = document.querySelector(`a[href="#${chapter.id}"]`);
            if (link) {
                const prog = updateChapterProgress(chapter.id);
                link.textContent = `${chapter.title} (${prog.checked}/${prog.total})`;
            }
        };
        content.appendChild(checkAllBtn);

        const h2 = document.createElement('h2');
        h2.textContent = chapter.title;
        content.appendChild(h2);

        chapter.sections.forEach(sec => {
            const sectionDiv = document.createElement('div');
            sectionDiv.classList.add('section');
            const h3 = document.createElement('h3');
            h3.textContent = sec.title;
            sectionDiv.appendChild(h3);

            sec.items.forEach((itemObj, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('item');

                // Pas d'icÃ´ne ici pour Ã©viter les problÃ¨mes
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                const key = `${chapter.id}-${sec.title}-${index}`;
                checkbox.checked = !!progress[key];

                checkbox.addEventListener('change', () => {
                    progress[key] = checkbox.checked;
                    localStorage.setItem('subnautica-progress', JSON.stringify(progress));
                    const prog = updateChapterProgress(chapter.id);
                    const link = document.querySelector(`a[href="#${chapter.id}"]`);
                    if (link) link.textContent = `${chapter.title} (${prog.checked}/${prog.total})`;
                    updateGlobalProgress();
                });

                const label = document.createElement('label');
                label.textContent = typeof itemObj === 'string' ? itemObj : itemObj.text;

                itemDiv.appendChild(checkbox);
                itemDiv.appendChild(label);
                sectionDiv.appendChild(itemDiv);
            });

            content.appendChild(sectionDiv);
        });

        document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
        const activeLink = document.querySelector(`a[href="#${chapter.id}"]`);
        if (activeLink) activeLink.classList.add('active');
    }

    const hash = window.location.hash.substring(1);
    let initialChapter = data.chapters.find(ch => ch.id === hash) || data.chapters[0];
    renderChapter(initialChapter);
    updateGlobalProgress();

    resetLink.addEventListener('click', (e) => {
        e.preventDefault();
        if (confirm('Voulez-vous vraiment tout rÃ©initialiser ?')) {
            localStorage.removeItem('subnautica-progress');
            progress = {};
            location.reload();
        }
    });
});
